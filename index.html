<!DOCTYPE html>
<html class="dark" lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Halaman Kontrol Lampu</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

<!-- Tailwind CDN (for convenience) -->
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          "primary": "#36e27b",
          "background-light": "#f6f8f7",
          "background-dark": "#112117",
          "card-dark": "#1b3224",
        },
        fontFamily: { "display": ["Spline Sans", "sans-serif"] },
        borderRadius: {"DEFAULT":"1rem","lg":"2rem","xl":"3rem","full":"9999px"}
      }
    }
  }
</script>

<style>
/* Additional small CSS overrides to match UI exactly and hide scrollbars */
html,body { font-family: "Spline Sans", "Noto Sans", sans-serif; }
.scrollbar-hide::-webkit-scrollbar { display: none; }
.scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
input[type=range] { -webkit-appearance:none; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:20px; height:30px; background:#000; cursor:pointer; }
</style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-gray-900 dark:text-white antialiased min-h-screen flex flex-col overflow-x-hidden">
<!-- Top Navigation -->
<header class="sticky top-0 z-50 flex items-center justify-between p-4 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md">
  <button class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
    <span class="material-symbols-outlined text-2xl">arrow_back</span>
  </button>
  <h1 class="text-lg font-bold tracking-tight">Capsule A-204</h1>
  <button class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
    <span class="material-symbols-outlined text-2xl">settings</span>
  </button>
</header>

<!-- Main Content Area -->
<main class="flex-1 flex flex-col gap-6 p-4">
  <!-- Status & Visualization -->
  <div class="flex flex-col items-center justify-center pt-2 pb-6 relative">
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-primary/20 rounded-full blur-3xl pointer-events-none"></div>
    <div class="z-10 text-center mb-8">
      <h2 class="text-3xl font-bold mb-1">Ambient Light</h2>
      <div class="flex items-center justify-center gap-2 text-primary">
        <span class="w-2 h-2 rounded-full bg-primary animate-pulse"></span>
        <span class="text-sm font-medium">IoT Connected • <span id="latencyLabel">—</span></span>
      </div>
    </div>

    <!-- Main Power Toggle (Circular) -->
    <button id="mainPowerBtn" class="group relative flex items-center justify-center w-48 h-48 rounded-full bg-gradient-to-br from-[#2a4d38] to-[#122118] shadow-[0_10px_40px_-10px_rgba(0,0,0,0.5)] border-4 border-[#366348]/30 transition-all active:scale-95">
      <div class="absolute inset-2 rounded-full border border-primary/20"></div>
      <div class="flex flex-col items-center gap-2 z-10">
        <span class="material-symbols-outlined text-6xl text-white drop-shadow-[0_0_15px_rgba(54,226,123,0.8)]">power_settings_new</span>
        <span id="powerLabel" class="text-primary font-bold tracking-widest text-sm uppercase">Power On</span>
      </div>
      <div id="powerGlow" class="absolute inset-0 rounded-full shadow-[inset_0_0_20px_rgba(54,226,123,0.2)]" style="display:block"></div>
    </button>
  </div>

  <!-- Controls Container -->
  <div class="bg-white dark:bg-card-dark rounded-xl p-6 shadow-lg border border-gray-100 dark:border-white/5 flex flex-col gap-8">
    <!-- Brightness Slider -->
    <div class="flex flex-col gap-3">
      <div class="flex justify-between items-center text-sm font-medium text-gray-500 dark:text-gray-400">
        <span>Brightness</span>
        <span id="brightnessPct" class="text-primary">85%</span>
      </div>
      <div class="flex items-center gap-4">
        <span class="material-symbols-outlined text-gray-400">brightness_low</span>
        <div class="relative w-full h-6 flex items-center">
          <input id="brightness" class="w-full h-1 bg-gray-200 dark:bg-[#366348] rounded-lg appearance-none cursor-pointer z-10" max="100" min="0" type="range" value="85"/>
          <div id="filledTrack" class="absolute left-0 top-1/2 -translate-y-1/2 h-1 bg-primary rounded-l-lg pointer-events-none" style="width:85%;"></div>
        </div>
        <span class="material-symbols-outlined text-white">brightness_high</span>
      </div>
    </div>

    <!-- Color Picker -->
    <div class="flex flex-col gap-3">
      <div class="flex justify-between items-center text-sm font-medium text-gray-500 dark:text-gray-400">
        <span>Color</span>
        <span class="flex items-center gap-1"><div id="currentColorDot" class="w-3 h-3 rounded-full bg-[#36e27b]"></div> <span id="currentColorName">Neon Green</span></span>
      </div>
      <div id="colorContainer" class="flex overflow-x-auto pb-2 gap-4 scrollbar-hide snap-x">
        <!-- color options with data-hue -->
        <label class="shrink-0 relative group cursor-pointer snap-center">
          <input checked class="peer sr-only colorRadio" name="color" type="radio" data-hue="96"/>
          <div class="w-12 h-12 rounded-full bg-[#36e27b] border-2 border-transparent peer-checked:border-white peer-checked:ring-2 peer-checked:ring-primary/50 transition-all scale-100 peer-checked:scale-110 shadow-lg shadow-primary/20"></div>
        </label>
        <label class="shrink-0 relative group cursor-pointer snap-center">
          <input class="peer sr-only colorRadio" name="color" type="radio" data-hue="16"/>
          <div class="w-12 h-12 rounded-full bg-[#FF5733] border-2 border-transparent peer-checked:border-white peer-checked:ring-2 peer-checked:ring-[#FF5733]/50 transition-all scale-100 peer-checked:scale-110"></div>
        </label>
        <label class="shrink-0 relative group cursor-pointer snap-center">
          <input class="peer sr-only colorRadio" name="color" type="radio" data-hue="160"/>
          <div class="w-12 h-12 rounded-full bg-[#3380FF] border-2 border-transparent peer-checked:border-white peer-checked:ring-2 peer-checked:ring-[#3380FF]/50 transition-all scale-100 peer-checked:scale-110"></div>
        </label>
        <label class="shrink-0 relative group cursor-pointer snap-center">
          <input class="peer sr-only colorRadio" name="color" type="radio" data-hue="200"/>
          <div class="w-12 h-12 rounded-full bg-[#E633FF] border-2 border-transparent peer-checked:border-white peer-checked:ring-2 peer-checked:ring-[#E633FF]/50 transition-all scale-100 peer-checked:scale-110"></div>
        </label>
        <label class="shrink-0 relative group cursor-pointer snap-center">
          <input class="peer sr-only colorRadio" name="color" type="radio" data-hue="30"/>
          <div class="w-12 h-12 rounded-full bg-[#FFDCA4] border-2 border-transparent peer-checked:border-white peer-checked:ring-2 peer-checked:ring-[#FFDCA4]/50 transition-all scale-100 peer-checked:scale-110"></div>
        </label>
        <label class="shrink-0 relative group cursor-pointer snap-center">
          <input class="peer sr-only colorRadio" name="color" type="radio" data-hue="0"/>
          <div class="w-12 h-12 rounded-full bg-[#FF3333] border-2 border-transparent peer-checked:border-white peer-checked:ring-2 peer-checked:ring-[#FF3333]/50 transition-all scale-100 peer-checked:scale-110"></div>
        </label>
      </div>
    </div>

    <!-- Presets / Moods -->
    <div>
      <h3 class="text-lg font-bold mb-4 px-1">Mood Scenes</h3>
      <div class="grid grid-cols-2 gap-4">
        <button class="presetBtn flex flex-col gap-3 p-4 rounded-xl bg-white dark:bg-card-dark border border-gray-100 dark:border-white/5 shadow-sm active:scale-95 transition-transform text-left group hover:border-primary/50" data-mode="reading">
          <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 group-hover:bg-blue-500 group-hover:text-white transition-colors">
            <span class="material-symbols-outlined">menu_book</span>
          </div>
          <div>
            <p class="font-bold text-base leading-tight">Reading</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cool white • 100%</p>
          </div>
        </button>

        <button class="presetBtn flex flex-col gap-3 p-4 rounded-xl bg-white dark:bg-card-dark border border-gray-100 dark:border-white/5 shadow-sm active:scale-95 transition-transform text-left group hover:border-primary/50" data-mode="sleep">
          <div class="w-10 h-10 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-400 group-hover:bg-orange-500 group-hover:text-white transition-colors">
            <span class="material-symbols-outlined">bedtime</span>
          </div>
          <div>
            <p class="font-bold text-base leading-tight">Sleep</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Warm dim • 20%</p>
          </div>
        </button>

        <button class="presetBtn flex flex-col gap-3 p-4 rounded-xl bg-white dark:bg-card-dark border border-gray-100 dark:border-white/5 shadow-sm active:scale-95 transition-transform text-left group hover:border-primary/50" data-mode="focus">
          <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 group-hover:bg-purple-500 group-hover:text-white transition-colors">
            <span class="material-symbols-outlined">laptop_chromebook</span>
          </div>
          <div>
            <p class="font-bold text-base leading-tight">Focus</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Daylight • 100%</p>
          </div>
        </button>

        <button class="presetBtn flex flex-col gap-3 p-4 rounded-xl bg-white dark:bg-card-dark border border-gray-100 dark:border-white/5 shadow-sm active:scale-95 transition-transform text-left group hover:border-primary/50" data-mode="party">
          <div class="w-10 h-10 rounded-full bg-pink-500/20 flex items-center justify-center text-pink-400 group-hover:bg-pink-500 group-hover:text-white transition-colors">
            <span class="material-symbols-outlined">celebration</span>
          </div>
          <div>
            <p class="font-bold text-base leading-tight">Party</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Color loop • 80%</p>
          </div>
        </button>
      </div>
    </div>

    <!-- Master Switch Card -->
    <div class="mt-2">
      <div class="flex items-center justify-between gap-4 rounded-xl bg-gradient-to-r from-card-dark to-[#16291e] p-5 shadow-lg border border-white/5">
        <div class="flex flex-col gap-1">
          <p class="text-white text-base font-bold leading-tight">Master Switch</p>
          <p class="text-[#95c6a9] text-xs font-normal leading-normal">Turn off all capsule devices</p>
        </div>
        <label class="relative inline-flex items-center cursor-pointer">
          <input id="masterSwitch" checked class="sr-only peer" type="checkbox" value=""/>
          <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
        </label>
      </div>
    </div>

    <div class="h-10"></div> <!-- Bottom Spacer -->
  </div>
</main>

<!-- Inline JS (terintegrasi) -->
<script>
/*
  Script UI Single-File (FINAL)
  - Brightness track FIXED (pixel-based)
  - Color swatch accuracy improved (always send sat=255)
  - Fully matches ESP32 WS2815 API
*/

const ESP_IP = "http://192.168.4.1:80"; // AP mode default

const latencyLabel = document.getElementById('latencyLabel');
const mainPowerBtn = document.getElementById('mainPowerBtn');
const powerLabel = document.getElementById('powerLabel');
const powerGlow = document.getElementById('powerGlow');

const brightnessInput = document.getElementById('brightness');
const brightnessPct = document.getElementById('brightnessPct');
const filledTrack = document.getElementById('filledTrack');

const colorRadios = document.querySelectorAll('.colorRadio');
const currentColorDot = document.getElementById('currentColorDot');
const currentColorName = document.getElementById('currentColorName');

const presetButtons = document.querySelectorAll('.presetBtn');
const masterSwitch = document.getElementById('masterSwitch');


// ========== SAFE FETCH ==========
async function safeFetch(url) {
  try {
    const t0 = performance.now();
    const res = await fetch(url, { cache: "no-store" });
    const t1 = performance.now();
    latencyLabel.textContent = Math.round(t1 - t0) + 'ms';
    return res;
  } catch (e) {
    latencyLabel.textContent = 'offline';
    return null;
  }
}


// ========== FIXED FILLED TRACK (NO MORE OVERFLOW) ==========
function setFilledTrackFromPercent(percent) {
  const totalPx = brightnessInput.clientWidth || brightnessInput.offsetWidth || 1;
  const thumbPx = 20; // approx width of thumb
  const usablePx = Math.max(0, totalPx - thumbPx);
  const px = Math.round((percent / 100) * usablePx);
  filledTrack.style.width = px + 'px';
}


// ========== UPDATE STATUS ==========
async function updateStatus() {
  const res = await safeFetch(ESP_IP + '/status');
  if (!res || !res.ok) return;

  const j = await res.json();

  // POWER
  powerLabel.textContent = j.power ? "Power On" : "Power Off";
  powerGlow.style.display = j.power ? "block" : "none";
  masterSwitch.checked = j.power;

  // BRIGHTNESS (0..100)
  brightnessInput.value = j.brightness;
  brightnessPct.textContent = j.brightness + "%";
  setFilledTrackFromPercent(j.brightness);

  // HUE matching
  let matched = false;
  colorRadios.forEach(r => {
    if (parseInt(r.dataset.hue) === j.hue) {
      r.checked = true;
      matched = true;
    } else {
      r.checked = false;
    }
  });

  if (!matched) {
    currentColorDot.style.background = `hsl(${Math.round(j.hue / 255 * 360)}, 80%, 50%)`;
    currentColorName.textContent = `Hue ${j.hue}`;
  } else {
    const sel = document.querySelector(".colorRadio:checked");
    if (sel) {
      const swatch = sel.parentNode.querySelector("div");
      currentColorDot.style.background = getComputedStyle(swatch).backgroundColor;
      currentColorName.textContent = "";
    }
  }
}


// ========== EVENTS ==========

// Main Power Button
mainPowerBtn.addEventListener('click', async () => {
  await safeFetch(ESP_IP + '/power?state=toggle');
  setTimeout(updateStatus, 120);
});

// BRIGHTNESS
brightnessInput.addEventListener('input', async () => {
  const v = parseInt(brightnessInput.value);
  brightnessPct.textContent = v + "%";
  setFilledTrackFromPercent(v);
  await safeFetch(ESP_IP + '/brightness?value=' + v);
});

// COLOR SWATCHES — always send sat=255
colorRadios.forEach(r => {
  r.addEventListener('change', async () => {
    if (!r.checked) return;
    const hue = r.dataset.hue;

    // Always full saturation for swatch color accuracy
    await safeFetch(ESP_IP + '/set_hue?hue=' + hue + '&sat=255');

    // Update UI instantly
    const swatch = r.parentNode.querySelector("div");
    currentColorDot.style.background = getComputedStyle(swatch).backgroundColor;
    currentColorName.textContent = "";
  });
});

// PRESETS
presetButtons.forEach(b => {
  b.addEventListener('click', async () => {
    const mode = b.dataset.mode;
    await safeFetch(ESP_IP + '/preset?mode=' + mode);
    setTimeout(updateStatus, 200);
  });
});

// MASTER SWITCH (Power)
masterSwitch.addEventListener('change', async () => {
  const state = masterSwitch.checked ? "on" : "off";
  await safeFetch(ESP_IP + '/power?state=' + state);
  setTimeout(updateStatus, 120);
});


// ========== INITIAL LOOP ==========
updateStatus();
setInterval(updateStatus, 1500);
</script>
</body>
</html>
